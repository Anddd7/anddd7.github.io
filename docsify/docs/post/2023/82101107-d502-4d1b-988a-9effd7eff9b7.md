# 云原生左移：开发环境“一体”化 - 图解云原生应用的开发与调试

## 背景

（本文不探讨“测试”对软件质量的作用，只是给出线上开发、调试的相关思路）

微服务架构和 Kubernetes 的流行给复杂软件应用的开发和部署提供了便利，但同时也带来了新的复杂性。一个软件系统可能包含上百个微服务应用（或 replicas），以及数十个中间件和云服务依赖。导致大多数的微服务应用都只能在本地跑跑单测，有的甚至连编译都无法通过。

> "does it work on your machine?"
> "no, it only works on cluster"
![](https://s2.loli.net/2023/06/05/9dU5IOnfeFXrmsk.png)

即使本地可以运行某个微服务，但上下游服务和中间件的依赖、云上网络和集群差异，常常导致调试结果不甚理想。一旦返工又需要重新编译打包部署（CI/CD），等待部署生效的时间可能比修改代码的时间要长得多了 ...

![](https://s2.loli.net/2023/06/05/v1j2stXfigwDoA5.png)

我们单独看某一次代码提交和部署的时间并不是很长，但遇到未知的、棘手的问题，我们就需要反复尝试和验证，此时受到 CI/CD 和云端环境的限制，这个时间就会呈倍数增加

![](https://s2.loli.net/2023/06/05/SHrPGlmZihnOqw8.png)
![](https://s2.loli.net/2023/06/05/aQgvMZ8pHi7VBKe.png)

实际耗时

![](https://s2.loli.net/2023/06/05/zDCHl3OJpNTuRqb.png)

___

因此我们在思考，能不能把云端环境做成“本地环境”一样，能够即时修改、即时编译、即时生效 ...

![](https://s2.loli.net/2023/06/05/ViS4g15j29sPuMC.png)

（本地、开发机：指的是开发者的机器，在近端）
（远端、集群、云端：指的是云环境中的机器，在远端）

## 构建并替换测试镜像

![](https://pic1.zhimg.com/80/v2-f7f850f928d48866afc291fc10bc8ab8_1440w.webp)

由本地进行 “编译、打包（docker）、部署”，以跳过 CI/CD 阶段以节省跑流水线的时间。用临时生成的开发镜像对线上环境进行替换，然后重新测试整个链路。

![](https://pic4.zhimg.com/80/v2-fc326f231bdac873610e0d88964fcf53_1440w.webp)

当然也可以结合 Service Mesh，避免影响正常环境的使用。

优势

- 简单易懂

劣势

- 仍需打包 docker 镜像并且上传制品库（registry）
- Reload 时间在分钟级

相关开源技术：Skaffold

## VPN 组网

![](https://pic2.zhimg.com/80/v2-aba5162bddaf66c5ebb25fe5dfb3dde1_1440w.webp)

这种方式是基于 Overlay 网络的思路，将本地主机 peering 进集群网络作为一个 “运行指定 Pod 的节点”。通过 Service Mesh 等技术以某种规则拦截访问流量，并通过 VPN 隧道转发到本地，完成 “集群到本地” 的访问。当本地应用需要访问其他 Pod、云服务、集群内域名时，相应流量也会被本地的 VPN 拦截并转发到集群中，由集群内的代理进行处理。

优势

- 本地应用即本地开发，可做到热更新
- 只做网络转发，集群的工作负载不会因此增加太多

劣势

- 方案复杂，路由规则（基于 cluster ip、基于 dns、基于端口、基于协议）可能会很复杂
- 连接数较多时，代理（Traffic Manger）负载会很高，可能成为瓶颈
- 本地环境仍是近似线上环境，无法利用云上的插件（e.g. PV、Cloud Controller Manager）

相关开源技术：telepresence、kubevpn

> 扩展思路：  
>
> - 集群使用 Terway 网络，Pod 直接分配 VPC 内的网络地址  
> - 本地主机使用 VPN 连接到 VPC 网络  
> - 使用路由 + Service Mesh，实现本地主机（上的应用）和 Pod 互联

## 开发容器远程开发

![](https://pic2.zhimg.com/80/v2-a232ceb0676cbf1523c777b20ffba321_1440w.webp)

将开发环境打包成容器（即将容器作为开发环境）直接运行在集群内。相比方案一中国“构建并替换测试镜像”，这里的容器是一个包含 os、sdk、cli 的全功能容器，因此可以在容器内直接书写代码、编译并运行，不用频繁的构建整个镜像，只需要修改代码再 run 就行。还可以将容器暴露成远端主机，利用 VSCode Remote 插件进行远程开发。

优势

- 可热更新，开发环境即线上环境
- 定制开发容器，可以简化开发环境的配置（预装好相关工具）
- 本地只需要命令行或 IDE
- 安全性高，代码资料都在远端

劣势

- 集群工作负载增加（cpu/内存/带宽），原应用可能只需要 0.1c0.1g，而开发容器打底就需要 1c1g
- 需要暴露更多的端口

相关开源技术：Nocalhost、VSCode Server

> 扩展思路：可以把给程序员买 Mac 的钱省下来用到云上 😄

## Web IDE 远程开发

![](https://pic1.zhimg.com/80/v2-a0c70ee07ec4de634ed54654c39ece1c_1440w.webp)

开发容器和 Web IDE 其实是一个思路，即整个开发环境在远端。在开发容器的基础上更进一步，将 IDE 也放到远端，对本地的依赖更少，更容易做到集中化管理。

相关开源技术：[Coder](https://link.zhihu.com/?target=https%3A//coder.com/)、VSCode Web

### 脑洞

这里的 Web IDE 和现在业界的思路还不太一样。本质上，我们是希望能够做到云端开发、部署、运行是一体的，我们的 “代码开发环境“ 和 “dev 开发环境” 就是一个环境，在开发和调试阶段就能够使用到云上的资源。

比如，为开发容器分配独立的 configmap、secrets 和 serviceaccount，在容器内通过 vpc 的内网 ip 和端点来访问云服务。

![](https://s2.loli.net/2023/06/05/3iVTgwatB6h8vYD.png)

面对越来越复杂的软件系统，我的小 mac（6c16g）早已不堪重负。虽然 Web IDE 资源消耗会更大，但相应的对本地主机的要求也会降低，相当于把物理机合并成了集群的节点池，总的成本上可能还会降低。

