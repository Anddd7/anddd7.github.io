# 远程开发环境的可行性 - 图解云原生应用的开发与调试

微服务架构和 Kubernetes 的流行给软件应用的开发提供了便利，但同时也带来了复杂性。一个系统可能包含上百个微服务（或 replicas），以及数十个云服务和中间件依赖。导致大多数应用在程序员的笔记本电脑上都只能跑跑单测，有的甚至连编译都没法在本地进行。

> "it works on my computer"  
> "no"

即使本地可以运行和调试单个微服务，但大量的上下游服务和云中间件依赖，本地环境和线上环境差别很大，一旦返工又需要重新编译打包部署（CI/CD），等待部署生效时间可能比修改代码的时间长多了 ...

___

以下是最近笔者发现的几种方案，各有优劣

## 构建并替换测试镜像

![](https://pic1.zhimg.com/80/v2-f7f850f928d48866afc291fc10bc8ab8_1440w.webp)

其实就是本地执行 编译、打包（docker）、部署，跳过 CI/CD 流程以节省跑流水线的时间，随后用临时生成的镜像进行替换，然后重新测试整个链路。

当然也可以结合 Service Mesh，避免影响环境的正常使用

![](https://pic4.zhimg.com/80/v2-fc326f231bdac873610e0d88964fcf53_1440w.webp)

优势

- 简单易懂

劣势

- 仍需打包 docker 镜像并且上传制品库（registry）
- Reload 时间在分钟级

相关开源技术：Skaffold

## VPN 组网

![](https://pic2.zhimg.com/80/v2-aba5162bddaf66c5ebb25fe5dfb3dde1_1440w.webp)

这种方式是基于 Overlay 网络的思路，将本地主机 peering 进集群网络作为一个 “运行指定 Pod 的节点”\[1\]，再通过 Service Mesh 以某种规则拦截访问流量\[4\]，并通过 VPN 隧道转发到本地，完成 “集群到本地” 的访问。当本地应用需要访问其他 Pod、云服务、集群内域名时\[5\]，相应流量也会被本地的 VPN 拦截并转发到集群中，由集群内的代理进行处理。

优势

- 本地应用近似本地开发，可做到热更新
- 只做网络转发，集群负载不会因此增加太多

劣势

- 方案复杂，路由规则（基于 cluster ip、基于 dns、基于端口、基于协议）可能会很复杂
- 连接数较多时，代理（Traffic Manger）负载会很高，可能成为瓶颈
- 本地环境仍是近似线上环境，无法利用云上的插件（e.g. PV、Cloud Controller Manager）

相关开源技术：telepresence、kubevpn

> 扩展思路：  
> \- 集群使用 Terway 网络，Pod 直接分配 VPC 内的网络地址  
> \- 本地主机使用 VPN 连接到 VPC 网络  
> \- 使用路由 + Service Mesh，实现本地主机（上的应用）和 Pod 互联

## 开发容器远程开发

![](https://pic2.zhimg.com/80/v2-a232ceb0676cbf1523c777b20ffba321_1440w.webp)

将开发环境打包成容器（将容器作为开发环境）直接运行在集群内。相比方案一“构建并替换测试镜像”，这里的容器是一个包含 base、语言环境、命令行工具的全功能容器，因此可以在容器内直接写代码并运行，不用频繁的构建整个镜像，只需要修改代码就行。还可以将容器暴露成远端主机，利用 VSCode 插件进行远程开发。

优势

- 可热更新，开发环境即线上环境
- 定制开发容器，可以简化开发环境的配置（预装好相关工具）
- 本地只需要命令行或 IDE
- 安全性高，代码资料都在远端

劣势

- 集群负载增加（cpu/内存/带宽），原应用可能只需要 0.1c0.1g，而开发容器打底就需要 1c1g
- 需要暴露更多的端口

相关开源技术：Nocalhost、VSCode Server

## Web IDE 远程开发

![](https://pic1.zhimg.com/80/v2-a0c70ee07ec4de634ed54654c39ece1c_1440w.webp)

开发容器和 Web IDE 其实是一个思路，即运行环境在远端。

相关开源技术：[Coder](https://link.zhihu.com/?target=https%3A//coder.com/)、VSCode Web

### 脑洞

虽然 Web IDE 资源消耗会更大，但相应的对本地主机的要求也会降低，相当于把物理机合并成了集群的节点池，总的成本上可能还会降低。

我们在运行阶段，已经用 DevOps、容器化等技术实现了凤凰服务器，保证了各个环境的一致性。然而本地环境已经被遗忘了 —— 这只是一台孤零零的 PC 电脑而已
